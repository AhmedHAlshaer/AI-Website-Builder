plan:
  description: |
    The user wants a website built. Analyze the request provided in "{customer_request}".
    
    Create a comprehensive plan that includes:
    1. The chosen technology stack for the website (e.g., static HTML/CSS, Flask with Python backend, etc.), focusing on free and easily set up solutions.
    2. A list of the pages or components needed (with brief details of each).
    3. A complete file structure with specific files to create (e.g., HTML, CSS, JS, Python files) and their purpose in the project.
    4. For each file, include its path relative to the project root (e.g., "website/index.html", "website/static/style.css").
    
    IMPORTANT OUTPUT FORMAT:
    - Your output MUST be valid JSON that can be parsed
    - Structure: {
        "tech_stack": {"frontend": "...", "backend": "...", "other": "..."},
        "pages": [{"name": "...", "description": "...", "file": "..."}],
        "files": [
          {"path": "website/index.html", "type": "html", "purpose": "..."},
          {"path": "website/static/style.css", "type": "css", "purpose": "..."}
        ]
      }
    - Ensure all paths use forward slashes
    - Do not include any text outside the JSON object
    
  expected_output: |
    A valid JSON object containing:
    - tech_stack: object with frontend, backend, and other technology choices
    - pages: array of page objects with name, description, and file path
    - files: array of file objects with path, type, and purpose
    
    The JSON must be properly formatted and parseable.
    
  agent: team_lead
  output_file: plan.json

develop_frontend:
  description: |
    Based on the plan in the previous task, generate complete frontend code for the website.
    
    This includes:
    - HTML for all pages (with proper DOCTYPE, meta tags, and semantic structure)
    - CSS for styling (responsive design, modern aesthetics)
    - JavaScript if needed for interactivity
    
    IMPORTANT OUTPUT FORMAT:
    For EACH file, use this exact format:
    
    === FILENAME: website/index.html ===
    <!DOCTYPE html>
    <html lang="en">
    ... (complete file content) ...
    </html>
    
    === FILENAME: website/static/style.css ===
    /* Complete CSS content */
    body { ... }
    
    Guidelines:
    - Provide COMPLETE file contents (no placeholders or "TODO" comments)
    - Include all necessary sections mentioned in the plan
    - Use modern, responsive design practices
    - Ensure all files are production-ready
    - Include comments explaining key sections
    - Make sure HTML files reference the correct CSS/JS file paths
    
  expected_output: |
    Complete frontend code with clear file markers.
    Each file should be preceded by "=== FILENAME: path/to/file ===" header.
    All code should be complete, properly formatted, and ready to use.
    
  agent: frontend_dev
  context: [plan]
  output_file: frontend_code.txt

develop_backend:
  description: |
    Based on the plan and frontend implementation, determine if backend functionality is needed.
    
    If backend is required (e.g., for form submissions, API endpoints):
    - Generate a Python web application (Flask or similar)
    - Include all necessary routes and handlers
    - Add proper error handling and validation
    - Include requirements.txt if dependencies are needed
    
    If NO backend is required:
    - Explicitly state "NO BACKEND REQUIRED"
    - Optionally provide a simple Python HTTP server script for local testing
    
    IMPORTANT OUTPUT FORMAT:
    For EACH file, use this exact format:
    
    === FILENAME: website/app.py ===
    from flask import Flask, render_template, request
    ... (complete file content) ...
    
    === FILENAME: website/requirements.txt ===
    flask==2.3.0
    ... (other dependencies) ...
    
    Guidelines:
    - Provide COMPLETE, runnable code (no placeholders)
    - Include all imports and error handling
    - Follow security best practices (CSRF protection, input validation)
    - Add comments explaining key logic
    - Ensure the server can start without errors
    
  expected_output: |
    Either:
    1. Complete backend code with file markers (=== FILENAME: ... ===) for each file, OR
    2. A clear statement "NO BACKEND REQUIRED" with optional simple server script
    
    If backend code is provided, it must be complete and runnable.
    
  agent: backend_dev
  context: [plan, develop_frontend]
  output_file: backend_code.txt
b
integrate_code:
  description: |
    Integrate the frontend and backend code into a runnable project structure on the file system.
    
    STEP-BY-STEP PROCESS:
    
    1. PARSE THE INPUTS:
       - Read the plan.json to understand the file structure
       - Parse frontend_code.txt to extract files (look for "=== FILENAME: ... ===" markers)
       - Parse backend_code.txt to extract files (look for "=== FILENAME: ... ===" markers)
    
    2. CREATE DIRECTORY STRUCTURE:
       - Use make_dir tool to create "website" directory
       - Use make_dir to create all subdirectories (e.g., "website/static", "website/templates")
       - Tool format: {"path": "website/static", "create_parents": true}
    
    3. WRITE FILES:
       - For each file extracted from frontend_code.txt and backend_code.txt:
         - Use write_file tool with format: {"path": "website/index.html", "content": "...", "create_parents": true}
         - Verify success after each write
         - If a write fails, log the error and continue (don't retry endlessly)
    
    4. ERROR HANDLING:
       - If a tool call fails 2 times in a row with same error, skip that file
       - Keep track of successful vs. failed files
       - DO NOT enter infinite retry loops
    
    5. VERIFICATION:
       - After writing all files, use exists tool to verify key files were created
       - Report success/failure counts
    
    CRITICAL REMINDERS:
    - Always include create_parents parameter in write_file calls
    - Extract file content between "=== FILENAME: X ===" and next "=== FILENAME:" or end of text
    - Handle files without "===" markers by using the filename from the plan
    - If you encounter the same error 2 times, STOP retrying that operation and move on
    
  expected_output: |
    A detailed integration report containing:
    1. List of directories created
    2. List of files successfully written (with paths)
    3. List of any files that failed to write (with error reasons)
    4. Summary: "Successfully integrated X/Y files"
    5. Final status: "Integration complete" or "Integration completed with errors"
    
    The report should be clear and actionable.
    
  agent: integrator
  context: [plan, develop_frontend, develop_backend]

test_run:
  description: |
    Perform comprehensive testing of the generated website project.
    
    TEST PROCEDURE:
    
    1. FILE EXISTENCE CHECK:
       - Use exists tool to verify all expected files from the plan exist
       - Check for: HTML files, CSS files, JS files, Python files (if backend)
       - Report any missing files
    
    2. FILE CONTENT VALIDATION:
       - Use read_file to check that files are not empty
       - For HTML files: verify they contain DOCTYPE, <html>, <head>, <body> tags
       - For CSS files: verify they contain valid CSS syntax (at least one rule)
       - For Python files: verify they contain valid Python syntax (import statements, etc.)
    
    3. FILE REFERENCE VALIDATION:
       - Check that HTML files reference CSS/JS files that actually exist
       - Example: if index.html has <link href="static/style.css">, verify "website/static/style.css" exists
    
    4. BACKEND TESTING (if applicable):
       - If app.py exists, check it has Flask imports
       - Verify requirements.txt exists if backend is present
       - Check that routes are defined
    
    5. GENERATE RUN INSTRUCTIONS:
       - For static sites: "Open website/index.html in your browser"
       - For Flask apps: "cd website && pip install -r requirements.txt && python app.py"
       - Include any setup steps needed
    
    OUTPUT FORMAT:
    
    TEST RESULTS
    ============
    Status: [PASS / FAIL / PARTIAL]
    
    Files Verified:
    ✓ website/index.html (exists, valid HTML)
    ✓ website/static/style.css (exists, valid CSS)
    ✗ website/app.py (MISSING - expected from plan)
    
    Issues Found:
    - [List any problems]
    
    How to Run:
    1. [Step by step instructions]
    2. [Additional steps if needed]
    
    Requirements:
    - [Any software needed: Python 3.x, browser, etc.]
    
  expected_output: |
    A comprehensive test report with:
    - Overall status (PASS/FAIL/PARTIAL)
    - Detailed list of verified files with checkmarks/crosses
    - List of any issues found
    - Clear, step-by-step instructions to run the website
    - Any setup requirements or dependencies
    
    The report should be clear enough for a non-technical user to follow.
    
  agent: tester
  context: [plan, develop_frontend, develop_backend, integrate_code]
  output_file: test_results.txt


analyze_existing:
  description: |
    The user has an existing website in the 'website/' directory and wants to make changes.
    
    User's edit request: "{edit_request}"
    
    YOUR TASKS:
    1. Use read_file and list_dir tools to explore the existing website structure
    2. Read all relevant files (HTML, CSS, JavaScript, Python) to understand current implementation
    3. Identify which files need to be MODIFIED (changed)
    4. Identify which NEW files need to be CREATED (for new features)
    5. Explain WHAT needs to change and WHY
    
    IMPORTANT: Don't just list file names - explain what currently exists and what needs to change.
    
    OUTPUT FORMAT:
    Create a clear analysis report with this structure:
    
    === CURRENT WEBSITE STRUCTURE ===
    List all existing files you found
    
    === FILES TO MODIFY ===
    For each file that needs changes:
    - File: website/path/to/file.html
    - Current state: (brief description of what's in the file now)
    - Changes needed: (detailed explanation of what to modify and why)
    
    === NEW FILES TO CREATE ===
    For each new file needed:
    - File: website/path/to/newfile.html
    - Purpose: (why this file is needed)
    - Content requirements: (what should be in it)
    
    === OVERALL CHANGE PLAN ===
    Summarize the modifications needed to achieve the user's request.
    
    Be thorough, clear, and actionable. The editor agent will use this to write code.
    
  expected_output: |
    A comprehensive text file containing:
    - Complete list of existing files
    - Detailed analysis of files to modify (with current state and required changes)
    - List of new files to create (with purpose and requirements)
    - Clear overall change plan
    
    Format should be easy to read and understand.
    
  agent: analyzer
  output_file: analysis_report.txt


plan_modifications:
  description: |
    Based on the analysis report, generate ALL the code needed to implement the user's requested changes.
    
    User's original request: "{edit_request}"
    
    REVIEW the analysis report from the previous task and implement ALL changes identified.
    
    CRITICAL INSTRUCTIONS:
    
    1. For MODIFIED files:
       - Provide the COMPLETE updated file content (entire file, not just the changed parts)
       - Don't just show snippets - the integrator needs the full file to overwrite
    
    2. For NEW files:
       - Provide COMPLETE file content from scratch
       - Mark them with [NEW FILE] tag
    
    3. Code quality requirements:
       - Production-ready code (no placeholders, no TODO comments)
       - Well-commented (explain what changed and why)
       - Integrates seamlessly with existing code
       - Modern, clean, and follows best practices
    
    4. OUTPUT FORMAT (MUST FOLLOW EXACTLY):
       Use file markers for each file:
       
       === FILENAME: website/index.html ===
       <!DOCTYPE html>
       <html lang="en">
       ... (COMPLETE file content) ...
       </html>
       
       === FILENAME: website/contact.html === [NEW FILE]
       <!DOCTYPE html>
       ... (COMPLETE new file content) ...
       </html>
    
    5. Technologies:
       - HTML with proper DOCTYPE and structure
       - CSS with responsive design
       - JavaScript for interactivity (if needed)
       - Python (Flask) for backend (if needed)
    
    Provide EVERYTHING the integrator needs to write the files successfully.
    
  expected_output: |
    Complete code for all modified and new files, with clear file markers.
    
    Format:
    - Each file preceded by "=== FILENAME: path/to/file ==="
    - New files marked with "[NEW FILE]"
    - Complete file contents (not snippets)
    - Well-commented, production-ready code
    
    The integrator will parse this output and write files to disk.
    
  agent: editor
  context: [analyze_existing]
  output_file: modifications_code.txt