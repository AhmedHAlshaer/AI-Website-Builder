plan:
  description: |
    The user wants a website built. Analyze the request provided in "{customer_request}".
    
    Create a comprehensive plan that includes:
    1. The chosen technology stack for the website (e.g., static HTML/CSS, Flask with Python backend, etc.), focusing on free and easily set up solutions.
    2. A list of the pages or components needed (with brief details of each).
    3. A complete file structure with specific files to create (e.g., HTML, CSS, JS, Python files) and their purpose in the project.
    4. For each file, include its path relative to the project root (e.g., "website/index.html", "website/static/style.css").
    
    IMPORTANT OUTPUT FORMAT:
    - Your output MUST be valid JSON that can be parsed
    - Structure: {
        "tech_stack": {"frontend": "...", "backend": "...", "other": "..."},
        "pages": [{"name": "...", "description": "...", "file": "..."}],
        "files": [
          {"path": "website/index.html", "type": "html", "purpose": "..."},
          {"path": "website/static/style.css", "type": "css", "purpose": "..."}
        ]
      }
    - Ensure all paths use forward slashes
    - Do not include any text outside the JSON object
    
  expected_output: |
    A valid JSON object containing:
    - tech_stack: object with frontend, backend, and other technology choices
    - pages: array of page objects with name, description, and file path
    - files: array of file objects with path, type, and purpose
    
    The JSON must be properly formatted and parseable.
    
  agent: team_lead
  output_file: plan.json

develop_frontend:
  description: |
    Based on the plan in the previous task, generate complete frontend code for the website.
    
    This includes:
    - HTML for all pages (with proper DOCTYPE, meta tags, and semantic structure)
    - CSS for styling (responsive design, modern aesthetics)
    - JavaScript if needed for interactivity
    
    IMPORTANT OUTPUT FORMAT:
    For EACH file, use this exact format:
    
    === FILENAME: website/index.html ===
    <!DOCTYPE html>
    <html lang="en">
    ... (complete file content) ...
    </html>
    
    === FILENAME: website/static/style.css ===
    /* Complete CSS content */
    body { ... }
    
    Guidelines:
    - Provide COMPLETE file contents (no placeholders or "TODO" comments)
    - Include all necessary sections mentioned in the plan
    - Use modern, responsive design practices
    - Ensure all files are production-ready
    - Include comments explaining key sections
    - Make sure HTML files reference the correct CSS/JS file paths
    
  expected_output: |
    Complete frontend code with clear file markers.
    Each file should be preceded by "=== FILENAME: path/to/file ===" header.
    All code should be complete, properly formatted, and ready to use.
    
  agent: frontend_dev
  context: [plan]
  output_file: frontend_code.txt

develop_backend:
  description: |
    Based on the plan and frontend implementation, determine if backend functionality is needed.
    
    If backend is required (e.g., for form submissions, API endpoints):
    - Generate a Python web application (Flask or similar)
    - Include all necessary routes and handlers
    - Add proper error handling and validation
    - Include requirements.txt if dependencies are needed
    
    If NO backend is required:
    - Explicitly state "NO BACKEND REQUIRED"
    - Optionally provide a simple Python HTTP server script for local testing
    
    IMPORTANT OUTPUT FORMAT:
    For EACH file, use this exact format:
    
    === FILENAME: website/app.py ===
    from flask import Flask, render_template, request
    ... (complete file content) ...
    
    === FILENAME: website/requirements.txt ===
    flask==2.3.0
    ... (other dependencies) ...
    
    Guidelines:
    - Provide COMPLETE, runnable code (no placeholders)
    - Include all imports and error handling
    - Follow security best practices (CSRF protection, input validation)
    - Add comments explaining key logic
    - Ensure the server can start without errors
    
  expected_output: |
    Either:
    1. Complete backend code with file markers (=== FILENAME: ... ===) for each file, OR
    2. A clear statement "NO BACKEND REQUIRED" with optional simple server script
    
    If backend code is provided, it must be complete and runnable.
    
  agent: backend_dev
  context: [plan, develop_frontend]
  output_file: backend_code.txt
b
integrate_code:
  description: |
    Integrate the frontend and backend code into a runnable project structure on the file system.
    
    STEP-BY-STEP PROCESS:
    
    1. PARSE THE INPUTS:
       - Read the plan.json to understand the file structure
       - Parse frontend_code.txt to extract files (look for "=== FILENAME: ... ===" markers)
       - Parse backend_code.txt to extract files (look for "=== FILENAME: ... ===" markers)
    
    2. CREATE DIRECTORY STRUCTURE:
       - Use make_dir tool to create "website" directory
       - Use make_dir to create all subdirectories (e.g., "website/static", "website/templates")
       - Tool format: {"path": "website/static", "create_parents": true}
    
    3. WRITE FILES:
       - For each file extracted from frontend_code.txt and backend_code.txt:
         - Use write_file tool with format: {"path": "website/index.html", "content": "...", "create_parents": true}
         - Verify success after each write
         - If a write fails, log the error and continue (don't retry endlessly)
    
    4. ERROR HANDLING:
       - If a tool call fails 2 times in a row with same error, skip that file
       - Keep track of successful vs. failed files
       - DO NOT enter infinite retry loops
    
    5. VERIFICATION:
       - After writing all files, use exists tool to verify key files were created
       - Report success/failure counts
    
    CRITICAL REMINDERS:
    - Always include create_parents parameter in write_file calls
    - Extract file content between "=== FILENAME: X ===" and next "=== FILENAME:" or end of text
    - Handle files without "===" markers by using the filename from the plan
    - If you encounter the same error 2 times, STOP retrying that operation and move on
    
  expected_output: |
    A detailed integration report containing:
    1. List of directories created
    2. List of files successfully written (with paths)
    3. List of any files that failed to write (with error reasons)
    4. Summary: "Successfully integrated X/Y files"
    5. Final status: "Integration complete" or "Integration completed with errors"
    
    The report should be clear and actionable.
    
  agent: integrator
  context: [plan, develop_frontend, develop_backend]

test_run:
  description: |
    Perform comprehensive testing of the generated website project.
    
    TEST PROCEDURE:
    
    1. FILE EXISTENCE CHECK:
       - Use exists tool to verify all expected files from the plan exist
       - Check for: HTML files, CSS files, JS files, Python files (if backend)
       - Report any missing files
    
    2. FILE CONTENT VALIDATION:
       - Use read_file to check that files are not empty
       - For HTML files: verify they contain DOCTYPE, <html>, <head>, <body> tags
       - For CSS files: verify they contain valid CSS syntax (at least one rule)
       - For Python files: verify they contain valid Python syntax (import statements, etc.)
    
    3. FILE REFERENCE VALIDATION:
       - Check that HTML files reference CSS/JS files that actually exist
       - Example: if index.html has <link href="static/style.css">, verify "website/static/style.css" exists
    
    4. BACKEND TESTING (if applicable):
       - If app.py exists, check it has Flask imports
       - Verify requirements.txt exists if backend is present
       - Check that routes are defined
    
    5. GENERATE RUN INSTRUCTIONS:
       - For static sites: "Open website/index.html in your browser"
       - For Flask apps: "cd website && pip install -r requirements.txt && python app.py"
       - Include any setup steps needed
    
    OUTPUT FORMAT:
    
    TEST RESULTS
    ============
    Status: [PASS / FAIL / PARTIAL]
    
    Files Verified:
    ✓ website/index.html (exists, valid HTML)
    ✓ website/static/style.css (exists, valid CSS)
    ✗ website/app.py (MISSING - expected from plan)
    
    Issues Found:
    - [List any problems]
    
    How to Run:
    1. [Step by step instructions]
    2. [Additional steps if needed]
    
    Requirements:
    - [Any software needed: Python 3.x, browser, etc.]
    
  expected_output: |
    A comprehensive test report with:
    - Overall status (PASS/FAIL/PARTIAL)
    - Detailed list of verified files with checkmarks/crosses
    - List of any issues found
    - Clear, step-by-step instructions to run the website
    - Any setup requirements or dependencies
    
    The report should be clear enough for a non-technical user to follow.
    
  agent: tester
  context: [plan, develop_frontend, develop_backend, integrate_code]
  output_file: test_results.txt